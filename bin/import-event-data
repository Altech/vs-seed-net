#!/usr/bin/env ruby

# This is a tool to import data generated by https://github.com/Altech/renza-publisher
# Please use via rails runner.

require 'pry' if Rails.env.development?

abort "Please specify data directory." if not ARGV.first
dir = Pathname.new ARGV.first
abort "The directory was not found." if not dir.exist?

j = JSON.parse (dir + 'metadata.json').read

begin
  ActiveRecord::Base.transaction do 

    # GameCenter
    unless GameCenter.where(location: j['location']).exists?
      puts "location:#{j['location']}"
      puts "Please input the station and the name by line."
      puts "  station:"; station = STDIN.gets.strip!
      puts "  name:";    name    = STDIN.gets.strip!
      puts "DONE!"
      game_center_record = {
        station: station,
        name: name,
        location: j['location']
      }
      GameCenter.create!(game_center_record)
    end
    game_center = GameCenter.where(location: j['location']).first

    ## delete and re-create if data already exists.
    if Event.where(youtube_playlist_id: j['playlist_id']).exists?
      event = Event.where(youtube_playlist_id: j['playlist_id']).first
      event.destroy
      Video.where(event_id: event.id).destroy_all
    end

    # Event
    event_record = {
      held_at: Time.parse(j['time']),
      game_center_id: game_center.id,
      youtube_playlist_id: j['playlist_id']}
    event = Event.create!(event_record)

    # Video
    j['video_ids'].each_with_index do |video_id,i|
      video_record = {
        youtube_video_id: video_id,
        event_id: event.id,
        win_or_lose: case j['win_or_lose'][i]
                     when 'win'
                       true
                     when 'lose'
                       false
                     else
                       puts "Win or lose data is empty!"
                       if Rails.env.development?
                         ret_val, raise_or_cont = nil, :raise
                         binding.pry
                         case raise_or_cont
                         when :raise 
                           raise "Invalid data:#{j}"
                         else # :cont
                           ret_val
                         end
                       else
                         raise "Invalid data:#{j}"
                       end
                     end
      }
      Video.create!(video_record)
    end
  end
rescue => e
  puts "All changes except GameCenter was rollbacked."
  p e.inspect
end
